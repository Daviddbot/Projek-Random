#include <DHT.h> 
#include <WiFi.h> 
#include <HTTPClient.h> 
 
#define DHTPIN 4     // Pin yang terhubung ke output sensor DHT11 
#define DHTTYPE DHT11   // Tipe sensor DHT (DHT11, DHT21, DHT22) 
 
  DHT dht(DHTPIN, DHTTYPE); 
  const char* ssid = "kris"; //Nama WiFi 
  const char* pass = "150713222014";//Password WiFi 
  //ganti domain 
  const char* serverName ="https://suhukelembaban.my.id/konek.php"; 
 
  const char* ntpServer = "pool.ntp.org"; 
  const long  gmtOffset_sec = 25200; // UTC+7 (7 * 3600 seconds) 
  const int   daylightOffset_sec = 0;  // Jakarta tidak menerapkan Daylight Saving Time 
 
   
void setup() { 
  Serial.begin(115200); /* Baud rate untuk komunikasi serial */ 
  // Inisialisasi WiFi 
  WiFi.begin(ssid, pass); 
  while (WiFi.status() != WL_CONNECTED) { 
    delay(1000); 
    Serial.println("Connecting to WiFi..."); 
  } 
  Serial.println("Connected to WiFi"); 
   
  dht.begin(); 
 
  // Init and get the time 
  configTime(gmtOffset_sec, daylightOffset_sec, ntpServer); 
} 
 
void loop() { 
  delay(2000);   
  postdata(); 
} 
 
 
void suhu(){ 
  float h = dht.readHumidity(); // Baca kelembaban relatif 
  float t = dht.readTemperature(); // Baca suhu dalam Celsius (default) 
 
  // Tampilkan nilai kelembaban dan suhu 
  Serial.print("Kelembaban: "); 
  Serial.print(h); 
  Serial.print(" %\t"); 
  Serial.print("Suhu: "); 
  Serial.print(t); 
  Serial.println(" Â°C"); 
  } 
 
void postdata() 
{ 
    struct tm timeinfo; 
    if(!getLocalTime(&timeinfo)){ 
      Serial.println("Failed to obtain time"); 
      return; 
    } 
 
    char formattedTime[50]; 
    strftime(formattedTime, sizeof(formattedTime), "%Y-%m-%d %H:%M:%S", &timeinfo); 
    Serial.println(String() + "WAKTU dari NTP : " + formattedTime); 
    Serial.println(); 
     
  suhu(); 
 
     
    String strkel = String(dht.readHumidity()); 
    String strsuhu = String(dht.readTemperature());   
    String strwaktu = String(formattedTime); 
     
//  Posting Data ke Database Server dengan Protokol HTTP 
    HTTPClient http; 
    http.begin(serverName); 
    http.addHeader("Content-Type", "application/x-www-form-urlencoded"); 
    String httpRequestData = "suhu=" + strsuhu + "&kelembaban=" + strkel +  "&tanggal=" + strwaktu ; 
     
    Serial.print("httpRequestData: "); 
    Serial.println(httpRequestData); 
    int httpResponseCode = http.POST(httpRequestData); 
    if (httpResponseCode>0) 
    { 
      Serial.print("HTTP Response code: "); 
      Serial.println(httpResponseCode); 
    } 
    else 
    { 
      Serial.print("Error code: "); 
      Serial.println(httpResponseCode); 
    } 
    http.end(); 
    delay(5000); 
 
  }
